# 要件定義書 - 手番タイマー最適化

## はじめに

現在、プレイヤーの手番が開始されるたびに常にタイマーが起動していますが、これは不要な場合があります。特に、ロン可能な状態でない限り、タイマーは必要ありません。この仕様では、手番タイマーの起動条件を最適化し、必要な場合のみタイマーを起動するようにします。

## 用語集

- **System**: 5枚麻雀ゲームシステム
- **Player**: ゲームに参加しているプレイヤー
- **Turn Timer**: プレイヤーの手番に設定される制限時間タイマー
- **Ron State**: 相手の捨て牌に対してロン（和了）が可能な状態
- **Riichi State**: プレイヤーがリーチを宣言している状態
- **Auto Draw**: 手番開始時に自動的に牌を引く処理

## 要件

### 要件1: タイマー起動条件の最適化

**ユーザーストーリー:** プレイヤーとして、不要なタイマーが表示されないことで、ゲームプレイがスムーズになることを期待します。

#### 受入基準

1. WHEN プレイヤーの手番が開始される時、THE System SHALL プレイヤーがロン待機状態であるかを判定する
2. IF プレイヤーがロン待機状態である時、THEN THE System SHALL 手番タイマーを起動する
3. IF プレイヤーがロン待機状態でない時、THEN THE System SHALL 手番タイマーを起動しない
4. WHEN 自動牌引きが実行される時、THE System SHALL タイマーを起動せずに処理を完了する
5. WHEN プレイヤーが牌を引いた後、THE System SHALL 通常の手番処理を開始する

### 要件2: ロン待機状態の判定

**ユーザーストーリー:** システムとして、プレイヤーがロン可能な状態にあるかを正確に判定し、適切にタイマーを制御したい。

#### 受入基準

1. WHEN 相手プレイヤーが牌を捨てる時、THE System SHALL リーチ中のプレイヤーに対してロン判定を実行する
2. IF ロン判定が可能である時、THEN THE System SHALL プレイヤーをロン待機状態に設定する
3. WHILE プレイヤーがロン待機状態である時、THE System SHALL ロン待機フラグを保持する
4. WHEN プレイヤーがロンを宣言する時、THE System SHALL ロン待機状態を解除する
5. WHEN ロン待機がタイムアウトする時、THE System SHALL ロン待機状態を解除する

### 要件3: タイマー制御の改善

**ユーザーストーリー:** プレイヤーとして、タイマーが適切なタイミングでのみ表示されることで、ゲームの流れが自然になることを期待します。

#### 受入基準

1. WHEN 手番タイマーが不要な場合、THE System SHALL タイマー起動処理をスキップする
2. WHEN 手番タイマーが必要な場合、THE System SHALL 30秒のタイマーを起動する
3. WHEN プレイヤーがアクションを実行する時、THE System SHALL タイマーをクリアする
4. WHEN ゲーム状態が変更される時、THE System SHALL 不要なタイマーをクリーンアップする

### 要件4: 自動牌引き処理の改善

**ユーザーストーリー:** プレイヤーとして、自動牌引きがスムーズに実行され、不要な待機時間がないことを期待します。

#### 受入基準

1. WHEN 手番が開始される時、THE System SHALL 自動牌引きの可否を判定する
2. IF 自動牌引きが許可される時、THEN THE System SHALL タイマーを起動せずに牌を引く
3. IF 自動牌引きが拒否される時、THEN THE System SHALL タイマーを起動してプレイヤーの操作を待つ
4. WHEN 自動牌引きが完了する時、THE System SHALL 次の手番処理に進む

### 要件5: クライアント側の表示制御

**ユーザーストーリー:** プレイヤーとして、タイマー表示が適切に制御され、混乱を招かないことを期待します。

#### 受入基準

1. WHEN サーバーからタイマー開始イベントを受信する時、THE System SHALL タイマー表示を開始する
2. WHEN タイマーが不要な場合、THE System SHALL タイマー表示を行わない
3. WHEN プレイヤーがアクションを実行する時、THE System SHALL タイマー表示をクリアする
4. WHEN ゲーム状態が更新される時、THE System SHALL タイマー表示の整合性を保つ
