# 実装タスクリスト - 手番タイマー最適化

## タスク一覧

- [x] 1. Playerクラスにロン待機状態管理機能を追加


  - `src/models/Player.js`にロン待機状態を管理するプロパティとメソッドを追加
  - `isWaitingForRon`プロパティを追加（初期値: false）
  - `ronWaitingTimeout`プロパティを追加（初期値: null）
  - `setRonWaiting()`メソッドを実装してロン待機状態を設定
  - `clearRonWaiting()`メソッドを実装してロン待機状態を解除
  - `isInRonWaitingState()`メソッドを実装して状態を取得
  - _要件: 2.3, 2.4, 2.5_



- [ ] 2. サーバー側にタイマー起動判定ロジックを実装
  - `server.js`に`shouldStartTurnTimer(game, autoDrawResult)`関数を追加
  - 自動牌引きが実行された場合はfalseを返すロジックを実装
  - プレイヤーがロン待機状態の場合はtrueを返すロジックを実装


  - その他の場合はfalseを返すロジックを実装
  - _要件: 3.1, 3.2_

- [ ] 3. handleAutoDrawTile関数の戻り値を拡張
  - `server.js`の`handleAutoDrawTile(game)`関数を修正


  - 自動牌引きが実行されたかどうかを示す`executed`プロパティを返す
  - 実行理由または拒否理由を示す`reason`プロパティを返す
  - 既存の処理ロジックを維持しながら戻り値を追加
  - _要件: 4.1, 4.2, 4.3, 4.4_

- [x] 4. startNextTurn関数を条件付きタイマー起動に変更


  - `server.js`の`startNextTurn(game)`関数を修正
  - `handleAutoDrawTile`の戻り値を受け取る
  - `shouldStartTurnTimer`を呼び出してタイマー起動の必要性を判定
  - 必要な場合のみ`setTurnTimer`を呼び出す
  - 不要な場合はタイマー起動をスキップ


  - _要件: 1.3, 1.4, 3.1_

- [ ] 5. ロン判定処理でロン待機状態を設定
  - `server.js`の`queryRon`イベントハンドラを修正
  - ロン判定が可能な場合、`player.setRonWaiting()`を呼び出す


  - 10秒後に自動的に`player.clearRonWaiting()`を呼び出すタイムアウトを設定
  - タイムアウトIDを`player.ronWaitingTimeout`に保存
  - _要件: 2.1, 2.2, 2.5_

- [x] 6. ロン宣言時とキャンセル時の状態クリア処理を追加


  - `server.js`の`declareRon`イベントハンドラに`player.clearRonWaiting()`を追加
  - `cancelRonWaiting`イベントハンドラを実装
  - プレイヤーのロン待機状態を解除する処理を実装
  - タイムアウトを適切にクリアする処理を実装



  - _要件: 2.4, 2.5_

- [ ] 7. クライアント側のタイマー表示制御を確認
  - `public/js/UIManager.js`のタイマー表示ロジックを確認
  - サーバーから`turnTimerStarted`イベントを受信した場合のみタイマーを表示
  - 不要なタイマー表示が発生しないことを確認
  - タイマークリア処理が適切に動作することを確認
  - _要件: 5.1, 5.2, 5.3, 5.4_

- [ ]* 8. エラーハンドリングの強化
  - タイマー起動判定でエラーが発生した場合のログ記録を追加
  - ロン待機状態の不整合が発生した場合の復旧処理を追加
  - タイムアウトの競合を防ぐための既存タイムアウトクリア処理を確認
  - _要件: 3.4_

- [ ]* 9. 統合テストの実施
  - 自動牌引きが実行される場合、タイマーが起動しないことを確認
  - ロン待機状態の場合、タイマーが起動することを確認
  - 通常の手番の場合、タイマーが起動しないことを確認
  - ロン判定とタイマーの連携が正しく動作することを確認
  - _要件: 1.1, 1.2, 1.3, 2.1, 2.2, 3.2_
