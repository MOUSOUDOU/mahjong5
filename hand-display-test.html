<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>手牌表示機能テスト</title>
    <link rel="stylesheet" href="public/styles.css">
    <style>
        .test-container {
            max-width: 900px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 10px;
        }

        .test-section {
            margin: 20px 0;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        .test-controls {
            text-align: center;
            margin: 20px 0;
        }

        .test-btn {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            background: #4caf50;
            color: white;
            cursor: pointer;
            font-size: 14px;
        }

        .test-btn:hover {
            background: #45a049;
        }

        .test-btn.secondary {
            background: #2196f3;
        }

        .test-btn.secondary:hover {
            background: #1976d2;
        }

        .test-btn.danger {
            background: #f44336;
        }

        .test-btn.danger:hover {
            background: #da190b;
        }

        .explanation {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 14px;
            line-height: 1.5;
        }

        .demo-hand {
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: nowrap;
            align-items: center;
            margin: 20px 0;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
            min-height: 90px;
        }

        .status-info {
            background: #fff3e0;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 14px;
            border-left: 4px solid #ff9800;
        }
    </style>
</head>

<body>
    <div class="test-container">
        <h1>手牌表示機能テスト</h1>

        <div class="explanation">
            <h3>🎯 実装された機能:</h3>
            <ul>
                <li><strong>牌を引く:</strong> 引いた牌は右端に表示（ソートしない）</li>
                <li><strong>牌を捨てる:</strong> 捨てた後、残りの牌を再ソートして表示</li>
                <li><strong>マウス操作:</strong> シングルクリック（選択）、ダブルクリック（捨てる）</li>
                <li><strong>視覚的区別:</strong> 引いた牌には区切り線と「引」マークを表示</li>
                <li><strong>レスポンシブ:</strong> 画面サイズに応じて適切にスケール</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>テスト1: 基本手牌表示（4枚）</h3>
            <p>ソートされた基本手牌を表示します</p>

            <div class="demo-hand" id="basic-hand"></div>

            <div class="test-controls">
                <button class="test-btn" onclick="showBasicHand()">基本手牌表示</button>
                <button class="test-btn secondary" onclick="shuffleBasicHand()">ランダム順序</button>
            </div>

            <div class="status-info">
                <strong>状態:</strong> 4枚の手牌がソートされて表示されます（索子1-9 → 字牌白發中）
            </div>
        </div>

        <div class="test-section">
            <h3>テスト2: 牌を引いた状態（5枚）</h3>
            <p>引いた牌が右端に分離表示されます</p>

            <div class="demo-hand" id="drawn-hand"></div>

            <div class="test-controls">
                <button class="test-btn" onclick="drawTile()">牌を引く</button>
                <button class="test-btn secondary" onclick="drawRandomTile()">ランダム牌を引く</button>
                <button class="test-btn danger" onclick="discardTile()">牌を捨てる</button>
            </div>

            <div class="status-info" id="drawn-status">
                <strong>状態:</strong> 「牌を引く」ボタンを押して引いた牌の表示を確認してください
            </div>
        </div>

        <div class="test-section">
            <h3>テスト3: 捨て牌後の再ソート</h3>
            <p>牌を捨てた後、残りの牌が再ソートされます</p>

            <div class="demo-hand" id="discard-hand"></div>

            <div class="test-controls">
                <button class="test-btn" onclick="simulateDiscardFlow()">捨て牌フロー実行</button>
                <button class="test-btn secondary" onclick="resetDiscardTest()">リセット</button>
            </div>

            <div class="status-info" id="discard-status">
                <strong>状態:</strong> 「捨て牌フロー実行」で一連の流れを確認できます
            </div>
        </div>

        <div class="test-section">
            <h3>テスト4: 重複牌の処理</h3>
            <p>引いた牌が手牌の中に既に存在する場合の表示テスト</p>

            <div class="demo-hand" id="duplicate-hand"></div>

            <div class="test-controls">
                <button class="test-btn" onclick="testDuplicateTiles()">重複牌テスト実行</button>
                <button class="test-btn secondary" onclick="resetDuplicateTest()">リセット</button>
            </div>

            <div class="status-info" id="duplicate-status">
                <strong>状態:</strong> 「重複牌テスト実行」で重複牌の処理を確認してください
            </div>
        </div>

        <div class="test-section">
            <h3>テスト5: マウス操作テスト</h3>
            <p>シングルクリック（選択）とダブルクリック（捨てる）の動作確認</p>

            <div class="demo-hand" id="mouse-test-hand"></div>

            <div class="test-controls">
                <button class="test-btn" onclick="setupMouseTest()">マウス操作テスト開始</button>
                <button class="test-btn secondary" onclick="resetMouseTest()">リセット</button>
            </div>

            <div class="status-info" id="mouse-test-status">
                <strong>操作方法:</strong> 牌をシングルクリック（選択）、ダブルクリック（捨てる）してください
            </div>
        </div>

        <div class="test-section">
            <h3>テスト6: レスポンシブ確認</h3>
            <p>ブラウザのウィンドウサイズを変更して、レスポンシブ動作を確認してください</p>

            <div class="demo-hand" id="responsive-hand"></div>

            <div class="test-controls">
                <button class="test-btn" onclick="showResponsiveTest()">レスポンシブテスト表示</button>
            </div>

            <div class="status-info">
                <strong>確認項目:</strong> 牌サイズ、区切り線、「引」マークが適切にスケールすること
            </div>
        </div>
    </div>

    <script>
        // 必要な関数をコピー
        function getTileDisplayText(tile) {
            if (tile.suit === 'bamboo') {
                return tile.value.toString();
            } else if (tile.suit === 'honor') {
                switch (tile.value) {
                    case 'white': return '白';
                    case 'green': return '發';
                    case 'red': return '中';
                    default: return tile.value;
                }
            }
            return tile.value;
        }

        function sortTilesForDisplay(tiles) {
            if (!Array.isArray(tiles)) {
                return [];
            }

            const validTiles = tiles.filter(tile =>
                tile &&
                typeof tile === 'object' &&
                tile.suit &&
                tile.value !== undefined &&
                tile.value !== null
            );

            if (validTiles.length === 0) {
                return [];
            }

            return [...validTiles].sort((a, b) => {
                const getSuitPriority = (tile) => {
                    if (tile.suit === 'bamboo') return 1;
                    if (tile.suit === 'honor') return 2;
                    return 3;
                };

                const getHonorPriority = (value) => {
                    switch (value) {
                        case 'white': return 1;
                        case 'green': return 2;
                        case 'red': return 3;
                        default: return 4;
                    }
                };

                const suitPriorityA = getSuitPriority(a);
                const suitPriorityB = getSuitPriority(b);

                if (suitPriorityA !== suitPriorityB) {
                    return suitPriorityA - suitPriorityB;
                }

                if (a.suit === 'bamboo' && b.suit === 'bamboo') {
                    const valueA = parseInt(a.value) || 0;
                    const valueB = parseInt(b.value) || 0;
                    return valueA - valueB;
                }

                if (a.suit === 'honor' && b.suit === 'honor') {
                    const priorityA = getHonorPriority(a.value);
                    const priorityB = getHonorPriority(b.value);
                    return priorityA - priorityB;
                }

                return 0;
            });
        }

        function createTileElement(tile, isClickable = false) {
            const tileElement = document.createElement('div');
            tileElement.className = 'tile';

            const displayText = getTileDisplayText(tile);
            tileElement.textContent = displayText;

            if (tile.suit === 'bamboo') {
                tileElement.classList.add('bamboo');
            } else if (tile.suit === 'honor') {
                tileElement.classList.add('honor');
            }

            if (isClickable) {
                tileElement.classList.add('clickable');
                tileElement.style.cursor = 'pointer';
            }

            return tileElement;
        }

        function displayPlayerHand(tiles, isClickable = false, drawnTile = null, containerId = 'player-hand') {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            if (!Array.isArray(tiles)) {
                return;
            }

            let handTiles = [...tiles];
            let separateDrawnTile = null;

            if (drawnTile) {
                separateDrawnTile = drawnTile;
                handTiles = tiles.filter(tile => tile.id !== drawnTile.id);
            } else if (tiles.length === 5) {
                separateDrawnTile = tiles[tiles.length - 1];
                handTiles = tiles.slice(0, -1);
            }

            const sortedTiles = sortTilesForDisplay(handTiles);

            sortedTiles.forEach(tile => {
                const tileElement = createTileElement(tile, isClickable);
                tileElement.classList.add('sorted-tile');
                container.appendChild(tileElement);
            });

            if (separateDrawnTile) {
                const separator = document.createElement('div');
                separator.className = 'tile-separator';
                separator.setAttribute('aria-hidden', 'true');
                container.appendChild(separator);

                const drawnTileElement = createTileElement(separateDrawnTile, isClickable);
                drawnTileElement.classList.add('drawn-tile');
                drawnTileElement.setAttribute('aria-label', `引いた牌: ${getTileDisplayText(separateDrawnTile)}`);
                container.appendChild(drawnTileElement);
            }
        }

        // テストデータ
        let currentHand = [
            { id: 'tile-1', suit: 'honor', value: 'red' },
            { id: 'tile-2', suit: 'bamboo', value: 5 },
            { id: 'tile-3', suit: 'honor', value: 'white' },
            { id: 'tile-4', suit: 'bamboo', value: 1 }
        ];

        let drawnTileData = null;

        // テスト関数
        function showBasicHand() {
            displayPlayerHand(currentHand, false, null, 'basic-hand');
        }

        function shuffleBasicHand() {
            const shuffled = [...currentHand].sort(() => Math.random() - 0.5);
            displayPlayerHand(shuffled, false, null, 'basic-hand');
        }

        function drawTile() {
            const newTile = { id: 'drawn-' + Date.now(), suit: 'bamboo', value: 7 };
            drawnTileData = newTile;
            const handWith5 = [...currentHand, newTile];
            displayPlayerHand(handWith5, true, newTile, 'drawn-hand');

            document.getElementById('drawn-status').innerHTML =
                '<strong>状態:</strong> 牌「7」を引きました。右端に区切り線と「引」マークが表示されています。';
        }

        function drawRandomTile() {
            const suits = ['bamboo', 'honor'];
            const bambooValues = [1, 2, 3, 4, 5, 6, 7, 8, 9];
            const honorValues = ['white', 'green', 'red'];

            const suit = suits[Math.floor(Math.random() * suits.length)];
            const value = suit === 'bamboo' ?
                bambooValues[Math.floor(Math.random() * bambooValues.length)] :
                honorValues[Math.floor(Math.random() * honorValues.length)];

            const newTile = { id: 'drawn-' + Date.now(), suit: suit, value: value };
            drawnTileData = newTile;
            const handWith5 = [...currentHand, newTile];
            displayPlayerHand(handWith5, true, newTile, 'drawn-hand');

            document.getElementById('drawn-status').innerHTML =
                `<strong>状態:</strong> 牌「${getTileDisplayText(newTile)}」を引きました。右端に区切り線と「引」マークが表示されています。`;
        }

        function discardTile() {
            if (!drawnTileData) {
                alert('先に牌を引いてください');
                return;
            }

            // 引いた牌を捨てる（実際のゲームでは任意の牌を選択可能）
            displayPlayerHand(currentHand, false, null, 'drawn-hand');
            drawnTileData = null;

            document.getElementById('drawn-status').innerHTML =
                '<strong>状態:</strong> 牌を捨てました。残りの4枚が再ソートされて表示されています。';
        }

        function simulateDiscardFlow() {
            const container = document.getElementById('discard-hand');
            const status = document.getElementById('discard-status');

            // ステップ1: 基本手牌
            status.innerHTML = '<strong>ステップ1:</strong> 基本手牌（4枚）を表示';
            displayPlayerHand(currentHand, false, null, 'discard-hand');

            setTimeout(() => {
                // ステップ2: 牌を引く
                status.innerHTML = '<strong>ステップ2:</strong> 牌「9」を引きました（右端に表示）';
                const newTile = { id: 'flow-drawn', suit: 'bamboo', value: 9 };
                const handWith5 = [...currentHand, newTile];
                displayPlayerHand(handWith5, true, newTile, 'discard-hand');

                setTimeout(() => {
                    // ステップ3: 牌を捨てる
                    status.innerHTML = '<strong>ステップ3:</strong> 牌「中」を捨てました（残り4枚を再ソート）';
                    const afterDiscard = currentHand.filter(t => t.value !== 'red').concat([newTile]);
                    displayPlayerHand(afterDiscard, false, null, 'discard-hand');
                }, 2000);
            }, 1500);
        }

        function resetDiscardTest() {
            displayPlayerHand(currentHand, false, null, 'discard-hand');
            document.getElementById('discard-status').innerHTML =
                '<strong>状態:</strong> 「捨て牌フロー実行」で一連の流れを確認できます';
        }

        function testDuplicateTiles() {
            const status = document.getElementById('duplicate-status');

            // 基本手牌（4枚）
            const baseHand = [
                { id: 'dup-1', suit: 'bamboo', value: 5 },
                { id: 'dup-2', suit: 'honor', value: 'white' },
                { id: 'dup-3', suit: 'bamboo', value: 1 },
                { id: 'dup-4', suit: 'honor', value: 'red' }
            ];

            status.innerHTML = '<strong>ステップ1:</strong> 基本手牌を表示（5, 白, 1, 中）';
            displayPlayerHand(baseHand, false, null, 'duplicate-hand');

            setTimeout(() => {
                // 重複する牌を引く（5を引く）
                const drawnDuplicate = { id: 'dup-5', suit: 'bamboo', value: 5 };
                const handWithDuplicate = [...baseHand, drawnDuplicate];

                status.innerHTML = '<strong>ステップ2:</strong> 既存の「5」と同じ牌を引きました（重複牌テスト）';
                displayPlayerHand(handWithDuplicate, true, drawnDuplicate, 'duplicate-hand');

                setTimeout(() => {
                    status.innerHTML = '<strong>結果:</strong> ✓ 基本手牌に「5」が1枚、引いた牌として「5」が1枚、合計2枚の「5」が正しく表示されています';
                }, 1500);
            }, 1500);
        }

        function resetDuplicateTest() {
            document.getElementById('duplicate-hand').innerHTML = '';
            document.getElementById('duplicate-status').innerHTML =
                '<strong>状態:</strong> 「重複牌テスト実行」で重複牌の処理を確認してください';
        }

        // マウス操作テスト用の変数
        let mouseTestHand = [];
        let selectedTileForTest = null;

        function setupMouseTest() {
            mouseTestHand = [
                { id: 'mouse-1', suit: 'bamboo', value: 3 },
                { id: 'mouse-2', suit: 'honor', value: 'white' },
                { id: 'mouse-3', suit: 'bamboo', value: 7 },
                { id: 'mouse-4', suit: 'honor', value: 'red' },
                { id: 'mouse-5', suit: 'bamboo', value: 9 }
            ];

            displayMouseTestHand();

            document.getElementById('mouse-test-status').innerHTML =
                '<strong>テスト開始:</strong> 牌をクリック（選択）またはダブルクリック（捨てる）してください';
        }

        function displayMouseTestHand() {
            const container = document.getElementById('mouse-test-hand');
            container.innerHTML = '';

            const drawnTile = mouseTestHand.length === 5 ? mouseTestHand[mouseTestHand.length - 1] : null;

            // ソート済み手牌を表示
            let handTiles = drawnTile ? mouseTestHand.slice(0, -1) : mouseTestHand;
            const sortedTiles = sortTilesForDisplay(handTiles);

            sortedTiles.forEach(tile => {
                const tileElement = createTileElement(tile, true);
                tileElement.classList.add('sorted-tile');

                // テスト用のイベントハンドラーを追加
                tileElement.addEventListener('click', (e) => {
                    e.preventDefault();
                    handleMouseTestClick(tile, tileElement);
                });

                tileElement.addEventListener('dblclick', (e) => {
                    e.preventDefault();
                    handleMouseTestDoubleClick(tile, tileElement);
                });

                container.appendChild(tileElement);
            });

            // 引いた牌がある場合
            if (drawnTile) {
                const separator = document.createElement('div');
                separator.className = 'tile-separator';
                container.appendChild(separator);

                const drawnTileElement = createTileElement(drawnTile, true);
                drawnTileElement.classList.add('drawn-tile');

                drawnTileElement.addEventListener('click', (e) => {
                    e.preventDefault();
                    handleMouseTestClick(drawnTile, drawnTileElement);
                });

                drawnTileElement.addEventListener('dblclick', (e) => {
                    e.preventDefault();
                    handleMouseTestDoubleClick(drawnTile, drawnTileElement);
                });

                container.appendChild(drawnTileElement);
            }
        }

        function handleMouseTestClick(tile, tileElement) {
            // 既存の選択を解除
            const previousSelected = document.querySelector('#mouse-test-hand .tile.selected');
            if (previousSelected) {
                previousSelected.classList.remove('selected');
            }

            // 新しい牌を選択
            selectedTileForTest = tile;
            tileElement.classList.add('selected');

            document.getElementById('mouse-test-status').innerHTML =
                `<strong>選択:</strong> 牌「${getTileDisplayText(tile)}」を選択しました。ダブルクリックで捨てることができます。`;
        }

        function handleMouseTestDoubleClick(tile, tileElement) {
            // 選択状態にする
            const previousSelected = document.querySelector('#mouse-test-hand .tile.selected');
            if (previousSelected) {
                previousSelected.classList.remove('selected');
            }

            selectedTileForTest = tile;
            tileElement.classList.add('selected');
            tileElement.classList.add('double-clicked');

            document.getElementById('mouse-test-status').innerHTML =
                `<strong>捨て牌:</strong> 牌「${getTileDisplayText(tile)}」をダブルクリックで捨てました！`;

            // 牌を手牌から除去
            setTimeout(() => {
                mouseTestHand = mouseTestHand.filter(t => t.id !== tile.id);
                displayMouseTestHand();

                if (mouseTestHand.length === 0) {
                    document.getElementById('mouse-test-status').innerHTML =
                        '<strong>完了:</strong> ✓ すべての牌を捨てました。マウス操作テスト成功！';
                } else {
                    document.getElementById('mouse-test-status').innerHTML =
                        `<strong>継続:</strong> 残り${mouseTestHand.length}枚。引き続きテストしてください。`;
                }
            }, 300);
        }

        function resetMouseTest() {
            document.getElementById('mouse-test-hand').innerHTML = '';
            selectedTileForTest = null;
            document.getElementById('mouse-test-status').innerHTML =
                '<strong>操作方法:</strong> 牌をシングルクリック（選択）、ダブルクリック（捨てる）してください';
        }

        function showResponsiveTest() {
            const testHand = [
                { id: 'resp-1', suit: 'bamboo', value: 1 },
                { id: 'resp-2', suit: 'bamboo', value: 5 },
                { id: 'resp-3', suit: 'honor', value: 'white' },
                { id: 'resp-4', suit: 'honor', value: 'green' },
                { id: 'resp-5', suit: 'bamboo', value: 9 }
            ];

            const drawnTile = testHand[testHand.length - 1];
            displayPlayerHand(testHand, true, drawnTile, 'responsive-hand');
        }

        // 初期化
        window.onload = function () {
            showBasicHand();
            showResponsiveTest();
        };
    </script>
</body>

</html>