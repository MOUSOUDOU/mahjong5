<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>モジュール統合テスト - ５枚麻雀</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 3px;
        }
        .test-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .test-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .test-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>モジュール統合テスト - ５枚麻雀</h1>
        </header>
        
        <main>
            <div class="test-section">
                <h2>1. モジュール初期化テスト</h2>
                <div id="module-init-results"></div>
                <button onclick="testModuleInitialization()">モジュール初期化テスト実行</button>
            </div>

            <div class="test-section">
                <h2>2. 牌ソート機能テスト</h2>
                <div id="tile-sort-results"></div>
                <button onclick="runTileSortTest()">牌ソートテスト実行</button>
            </div>

            <div class="test-section">
                <h2>3. テンパイ判定テスト</h2>
                <div id="tenpai-results"></div>
                <button onclick="runTenpaiTest()">テンパイ判定テスト実行</button>
            </div>

            <div class="test-section">
                <h2>4. エラーハンドリングテスト</h2>
                <div id="error-results"></div>
                <button onclick="testErrorHandling()">エラーハンドリングテスト実行</button>
            </div>

            <div class="test-section">
                <h2>5. 後方互換性テスト</h2>
                <div id="compatibility-results"></div>
                <button onclick="testBackwardCompatibility()">後方互換性テスト実行</button>
            </div>

            <div class="test-section">
                <h2>6. 全体統合テスト</h2>
                <div id="integration-results"></div>
                <button onclick="runIntegrationTest()">統合テスト実行</button>
            </div>

            <!-- テスト用のゲーム要素（非表示） -->
            <div style="display: none;">
                <div class="waiting-screen"></div>
                <div class="game-screen"></div>
                <div id="game-result"></div>
                <div id="player-hand"></div>
                <div id="opponent-hand"></div>
                <div id="player-discard-content"></div>
                <div id="opponent-discard-content"></div>
                <button id="riichi-btn"></button>
                <button id="ron-btn"></button>
                <button id="tsumo-btn"></button>
                <span id="current-turn"></span>
                <span id="remaining-tiles"></span>
                <span id="player-name"></span>
                <span id="opponent-name"></span>
                <span id="player-riichi"></span>
                <span id="opponent-riichi"></span>
                <div id="result-title"></div>
                <div id="result-message"></div>
                <button id="new-game-btn"></button>
            </div>
        </main>
    </div>

    <!-- Socket.ioのモック -->
    <script>
        // Socket.ioのモック実装
        window.io = function() {
            return {
                on: function(event, callback) {
                    console.log('Mock socket.on:', event);
                },
                emit: function(event, data) {
                    console.log('Mock socket.emit:', event, data);
                },
                connect: function() {
                    console.log('Mock socket.connect');
                },
                disconnect: function() {
                    console.log('Mock socket.disconnect');
                },
                id: 'mock-socket-id'
            };
        };
    </script>

    <!-- モジュールファイルを依存関係順に読み込み -->
    <script src="js/ErrorHandler.js"></script>
    <script src="js/SocketManager.js"></script>
    <script src="js/GameStateManager.js"></script>
    <script src="js/TileManager.js"></script>
    <script src="js/DiscardDisplayManager.js"></script>
    <script src="js/WinningManager.js"></script>
    <script src="js/UIManager.js"></script>
    <!-- メインスクリプト（最後に読み込み） -->
    <script src="script.js"></script>

    <script>
        // テスト関数群
        function addTestResult(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            const result = document.createElement('div');
            result.className = `test-result test-${type}`;
            result.textContent = message;
            container.appendChild(result);
        }

        function clearTestResults(containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
        }

        function testModuleInitialization() {
            clearTestResults('module-init-results');
            
            try {
                // モジュールの存在確認
                const modules = {
                    'ErrorHandler': window.ErrorHandler,
                    'SocketManager': window.SocketManager,
                    'GameStateManager': window.GameStateManager,
                    'TileManager': window.TileManager,
                    'DiscardDisplayManager': window.DiscardDisplayManager,
                    'WinningManager': window.WinningManager,
                    'UIManager': window.UIManager
                };

                let allModulesLoaded = true;
                for (const [name, module] of Object.entries(modules)) {
                    if (module) {
                        addTestResult('module-init-results', `✓ ${name}モジュールが正常に読み込まれました`, 'success');
                    } else {
                        addTestResult('module-init-results', `✗ ${name}モジュールが見つかりません`, 'error');
                        allModulesLoaded = false;
                    }
                }

                // インスタンスの存在確認
                const instances = {
                    'errorHandler': window.errorHandler,
                    'socketManager': window.socketManager,
                    'gameStateManager': window.gameStateManager,
                    'tileManager': window.tileManager,
                    'discardDisplayManager': window.discardDisplayManager,
                    'winningManager': window.winningManager,
                    'uiManager': window.uiManager
                };

                let allInstancesCreated = true;
                for (const [name, instance] of Object.entries(instances)) {
                    if (instance) {
                        addTestResult('module-init-results', `✓ ${name}インスタンスが作成されました`, 'success');
                    } else {
                        addTestResult('module-init-results', `✗ ${name}インスタンスが見つかりません`, 'error');
                        allInstancesCreated = false;
                    }
                }

                if (allModulesLoaded && allInstancesCreated) {
                    addTestResult('module-init-results', '✓ 全モジュールが正常に初期化されました', 'success');
                } else {
                    addTestResult('module-init-results', '✗ 一部のモジュールに問題があります', 'error');
                }

            } catch (error) {
                addTestResult('module-init-results', `✗ 初期化テストエラー: ${error.message}`, 'error');
            }
        }

        function runTileSortTest() {
            clearTestResults('tile-sort-results');
            
            try {
                if (typeof testTileSorting === 'function') {
                    const result = testTileSorting();
                    if (result) {
                        addTestResult('tile-sort-results', '✓ 牌ソート機能が正常に動作しています', 'success');
                    } else {
                        addTestResult('tile-sort-results', '✗ 牌ソート機能に問題があります', 'error');
                    }
                } else {
                    addTestResult('tile-sort-results', '✗ testTileSorting関数が見つかりません', 'error');
                }
            } catch (error) {
                addTestResult('tile-sort-results', `✗ 牌ソートテストエラー: ${error.message}`, 'error');
            }
        }

        function runTenpaiTest() {
            clearTestResults('tenpai-results');
            
            try {
                if (typeof testTenpaiCheck === 'function') {
                    testTenpaiCheck();
                    addTestResult('tenpai-results', '✓ テンパイ判定テストが実行されました（詳細はコンソールを確認）', 'success');
                } else {
                    addTestResult('tenpai-results', '✗ testTenpaiCheck関数が見つかりません', 'error');
                }
            } catch (error) {
                addTestResult('tenpai-results', `✗ テンパイ判定テストエラー: ${error.message}`, 'error');
            }
        }

        function testErrorHandling() {
            clearTestResults('error-results');
            
            try {
                if (window.errorHandler) {
                    // エラーメッセージテスト
                    window.errorHandler.showMessage('テストメッセージ', 1000);
                    addTestResult('error-results', '✓ メッセージ表示機能が動作しました', 'success');
                    
                    // エラー表示テスト
                    setTimeout(() => {
                        window.errorHandler.showError('テストエラー', 1000);
                        addTestResult('error-results', '✓ エラー表示機能が動作しました', 'success');
                    }, 500);
                    
                    // エラーメッセージ取得テスト
                    const errorMsg = window.errorHandler.getErrorMessage('invalid_move', 'デフォルト');
                    if (errorMsg === '無効な操作です') {
                        addTestResult('error-results', '✓ エラーメッセージ取得機能が正常です', 'success');
                    } else {
                        addTestResult('error-results', '✗ エラーメッセージ取得機能に問題があります', 'error');
                    }
                } else {
                    addTestResult('error-results', '✗ ErrorHandlerが初期化されていません', 'error');
                }
            } catch (error) {
                addTestResult('error-results', `✗ エラーハンドリングテストエラー: ${error.message}`, 'error');
            }
        }

        function testBackwardCompatibility() {
            clearTestResults('compatibility-results');
            
            try {
                // グローバル関数の存在確認
                const globalFunctions = [
                    'showError', 'showMessage', 'getErrorMessage',
                    'createTileElement', 'getTileDisplayText', 'sortTilesForDisplay',
                    'updateWinningButtons', 'checkWinningHand', 'hideWinningButtons',
                    'showGameScreen', 'showWaitingScreen', 'updateButtonStates'
                ];

                let compatibilityIssues = 0;
                for (const funcName of globalFunctions) {
                    if (typeof window[funcName] === 'function') {
                        addTestResult('compatibility-results', `✓ ${funcName}関数が利用可能です`, 'success');
                    } else {
                        addTestResult('compatibility-results', `✗ ${funcName}関数が見つかりません`, 'error');
                        compatibilityIssues++;
                    }
                }

                // グローバル変数の存在確認
                const globalVars = ['socket', 'currentGameState', 'playerId', 'selectedTile'];
                for (const varName of globalVars) {
                    if (varName in window) {
                        addTestResult('compatibility-results', `✓ ${varName}変数が定義されています`, 'success');
                    } else {
                        addTestResult('compatibility-results', `✗ ${varName}変数が見つかりません`, 'error');
                        compatibilityIssues++;
                    }
                }

                if (compatibilityIssues === 0) {
                    addTestResult('compatibility-results', '✓ 後方互換性が保たれています', 'success');
                } else {
                    addTestResult('compatibility-results', `✗ ${compatibilityIssues}個の互換性問題があります`, 'error');
                }

            } catch (error) {
                addTestResult('compatibility-results', `✗ 後方互換性テストエラー: ${error.message}`, 'error');
            }
        }

        function runIntegrationTest() {
            clearTestResults('integration-results');
            
            try {
                if (typeof testGameStateIntegration === 'function') {
                    const result = testGameStateIntegration();
                    if (result) {
                        addTestResult('integration-results', '✓ 統合テストが成功しました', 'success');
                    } else {
                        addTestResult('integration-results', '✗ 統合テストで問題が検出されました', 'error');
                    }
                } else {
                    addTestResult('integration-results', '✗ testGameStateIntegration関数が見つかりません', 'error');
                }

                // 追加の統合テスト
                if (window.modules) {
                    const moduleAccessor = window.modules;
                    addTestResult('integration-results', '✓ モジュールアクセサが利用可能です', 'success');
                    
                    // 各モジュールへのアクセステスト
                    const moduleNames = ['errorHandler', 'socketManager', 'gameStateManager', 'tileManager', 'discardDisplayManager', 'winningManager', 'uiManager'];
                    for (const moduleName of moduleNames) {
                        if (typeof moduleAccessor[moduleName] === 'function') {
                            const moduleInstance = moduleAccessor[moduleName]();
                            if (moduleInstance) {
                                addTestResult('integration-results', `✓ ${moduleName}モジュールにアクセス可能です`, 'success');
                            } else {
                                addTestResult('integration-results', `✗ ${moduleName}モジュールが初期化されていません`, 'error');
                            }
                        }
                    }
                }

            } catch (error) {
                addTestResult('integration-results', `✗ 統合テストエラー: ${error.message}`, 'error');
            }
        }

        // ページ読み込み後に自動実行
        window.addEventListener('load', () => {
            setTimeout(() => {
                addTestResult('module-init-results', 'ページが読み込まれました。テストを実行してください。', 'info');
            }, 1000);
        });
    </script>
</body>
</html>