<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>手牌ソート機能テスト</title>
    <link rel="stylesheet" href="public/styles.css">
    <style>
        .test-container {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 10px;
        }
        
        .test-section {
            margin: 20px 0;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        
        .test-hand {
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 10px 0;
        }
        
        .test-controls {
            text-align: center;
            margin: 20px 0;
        }
        
        .test-btn {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            background: #4caf50;
            color: white;
            cursor: pointer;
            font-size: 14px;
        }
        
        .test-btn:hover {
            background: #45a049;
        }
        
        .test-btn.secondary {
            background: #2196f3;
        }
        
        .test-btn.secondary:hover {
            background: #1976d2;
        }
        
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        
        .test-result.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .test-result.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .explanation {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 14px;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>手牌ソート機能テスト</h1>
        
        <div class="explanation">
            <h3>ソート仕様:</h3>
            <ul>
                <li><strong>索子（数牌）:</strong> 1から9の順番で左から配置</li>
                <li><strong>字牌:</strong> 白→發→中の順番で索子の右側に配置</li>
                <li><strong>全体順序:</strong> 索子（1-9） → 字牌（白發中）</li>
            </ul>
        </div>
        
        <div class="test-section">
            <h3>テスト1: 基本的なソート</h3>
            <p>ランダムな順序の牌を正しい順序にソートします</p>
            
            <div>
                <strong>ソート前:</strong>
                <div class="test-hand" id="before-hand-1"></div>
            </div>
            
            <div>
                <strong>ソート後:</strong>
                <div class="test-hand" id="after-hand-1"></div>
            </div>
            
            <div class="test-controls">
                <button class="test-btn" onclick="runBasicSortTest()">基本ソートテスト実行</button>
            </div>
            
            <div id="result-1" class="test-result" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <h3>テスト2: 複雑なケース</h3>
            <p>同じ牌が複数ある場合や、全種類の牌が混在する場合</p>
            
            <div>
                <strong>ソート前:</strong>
                <div class="test-hand" id="before-hand-2"></div>
            </div>
            
            <div>
                <strong>ソート後:</strong>
                <div class="test-hand" id="after-hand-2"></div>
            </div>
            
            <div class="test-controls">
                <button class="test-btn" onclick="runComplexSortTest()">複雑ケーステスト実行</button>
            </div>
            
            <div id="result-2" class="test-result" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <h3>テスト3: ランダム生成テスト</h3>
            <p>ランダムに生成された手牌をソートします</p>
            
            <div>
                <strong>ソート前:</strong>
                <div class="test-hand" id="before-hand-3"></div>
            </div>
            
            <div>
                <strong>ソート後:</strong>
                <div class="test-hand" id="after-hand-3"></div>
            </div>
            
            <div class="test-controls">
                <button class="test-btn secondary" onclick="generateRandomHand()">ランダム手牌生成</button>
                <button class="test-btn" onclick="runRandomSortTest()">ランダムソートテスト実行</button>
            </div>
            
            <div id="result-3" class="test-result" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <h3>自動テスト実行</h3>
            <div class="test-controls">
                <button class="test-btn secondary" onclick="runAllTests()">全テスト実行</button>
            </div>
            <div id="all-results"></div>
        </div>
    </div>

    <script>
        // 必要な関数をコピー（実際のゲームから）
        function getTileDisplayText(tile) {
            if (tile.suit === 'bamboo') {
                return tile.value.toString();
            } else if (tile.suit === 'honor') {
                switch (tile.value) {
                    case 'white': return '白';
                    case 'green': return '發';
                    case 'red': return '中';
                    default: return tile.value;
                }
            }
            return tile.value;
        }

        function sortTilesForDisplay(tiles) {
            if (!Array.isArray(tiles)) {
                console.warn('sortTilesForDisplay: 無効な牌データ', tiles);
                return [];
            }
            
            return [...tiles].sort((a, b) => {
                // 牌の種類による優先順位を決定
                const getSuitPriority = (tile) => {
                    if (tile.suit === 'bamboo') return 1; // 索子が最優先
                    if (tile.suit === 'honor') return 2;  // 字牌が次
                    return 3; // その他（unknown等）は最後
                };
                
                // 字牌の値による優先順位を決定
                const getHonorPriority = (value) => {
                    switch (value) {
                        case 'white': return 1; // 白
                        case 'green': return 2; // 發
                        case 'red': return 3;   // 中
                        default: return 4;      // その他
                    }
                };
                
                const suitPriorityA = getSuitPriority(a);
                const suitPriorityB = getSuitPriority(b);
                
                // まず牌の種類でソート
                if (suitPriorityA !== suitPriorityB) {
                    return suitPriorityA - suitPriorityB;
                }
                
                // 同じ種類の牌の場合、値でソート
                if (a.suit === 'bamboo' && b.suit === 'bamboo') {
                    // 索子は数値順（1-9）
                    const valueA = parseInt(a.value) || 0;
                    const valueB = parseInt(b.value) || 0;
                    return valueA - valueB;
                }
                
                if (a.suit === 'honor' && b.suit === 'honor') {
                    // 字牌は白→發→中の順
                    const priorityA = getHonorPriority(a.value);
                    const priorityB = getHonorPriority(b.value);
                    return priorityA - priorityB;
                }
                
                // その他の場合は元の順序を保持
                return 0;
            });
        }

        function createTileElement(tile) {
            const tileElement = document.createElement('div');
            tileElement.className = 'tile';
            
            const displayText = getTileDisplayText(tile);
            tileElement.textContent = displayText;
            
            if (tile.suit === 'bamboo') {
                tileElement.classList.add('bamboo');
            } else if (tile.suit === 'honor') {
                tileElement.classList.add('honor');
            }
            
            return tileElement;
        }

        function displayTiles(tiles, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            tiles.forEach(tile => {
                const tileElement = createTileElement(tile);
                container.appendChild(tileElement);
            });
        }

        function showResult(resultId, success, message) {
            const resultElement = document.getElementById(resultId);
            resultElement.style.display = 'block';
            resultElement.className = `test-result ${success ? 'success' : 'error'}`;
            resultElement.textContent = message;
        }

        // テスト1: 基本的なソート
        function runBasicSortTest() {
            const testTiles = [
                { id: 'test-1', suit: 'honor', value: 'red' },     // 中
                { id: 'test-2', suit: 'bamboo', value: 5 },        // 5
                { id: 'test-3', suit: 'honor', value: 'white' },   // 白
                { id: 'test-4', suit: 'bamboo', value: 1 },        // 1
                { id: 'test-5', suit: 'honor', value: 'green' },   // 發
                { id: 'test-6', suit: 'bamboo', value: 9 },        // 9
                { id: 'test-7', suit: 'bamboo', value: 3 },        // 3
            ];

            displayTiles(testTiles, 'before-hand-1');
            
            const sortedTiles = sortTilesForDisplay(testTiles);
            displayTiles(sortedTiles, 'after-hand-1');

            const expectedOrder = ['1', '3', '5', '9', '白', '發', '中'];
            const actualOrder = sortedTiles.map(t => getTileDisplayText(t));
            
            const isCorrect = JSON.stringify(expectedOrder) === JSON.stringify(actualOrder);
            
            showResult('result-1', isCorrect, 
                isCorrect ? '✓ 基本ソートテスト成功' : 
                `✗ 基本ソートテスト失敗 - 期待値: ${expectedOrder.join(' ')}, 実際値: ${actualOrder.join(' ')}`
            );
        }

        // テスト2: 複雑なケース
        function runComplexSortTest() {
            const testTiles = [
                { id: 'test-1', suit: 'bamboo', value: 7 },
                { id: 'test-2', suit: 'bamboo', value: 2 },
                { id: 'test-3', suit: 'honor', value: 'green' },
                { id: 'test-4', suit: 'bamboo', value: 2 },        // 重複
                { id: 'test-5', suit: 'honor', value: 'white' },
                { id: 'test-6', suit: 'bamboo', value: 8 },
                { id: 'test-7', suit: 'honor', value: 'red' },
                { id: 'test-8', suit: 'bamboo', value: 4 },
            ];

            displayTiles(testTiles, 'before-hand-2');
            
            const sortedTiles = sortTilesForDisplay(testTiles);
            displayTiles(sortedTiles, 'after-hand-2');

            // 期待される順序: 2, 2, 4, 7, 8, 白, 發, 中
            const actualOrder = sortedTiles.map(t => getTileDisplayText(t));
            
            // 索子が数値順で、字牌が白發中順であることを確認
            let isCorrect = true;
            let bambooTiles = [];
            let honorTiles = [];
            
            sortedTiles.forEach(tile => {
                if (tile.suit === 'bamboo') {
                    bambooTiles.push(parseInt(tile.value));
                } else if (tile.suit === 'honor') {
                    honorTiles.push(tile.value);
                }
            });
            
            // 索子が昇順かチェック
            for (let i = 1; i < bambooTiles.length; i++) {
                if (bambooTiles[i] < bambooTiles[i-1]) {
                    isCorrect = false;
                    break;
                }
            }
            
            // 字牌が正しい順序かチェック
            const expectedHonorOrder = ['white', 'green', 'red'];
            const honorOrderCorrect = honorTiles.every((value, index) => {
                const expectedIndex = expectedHonorOrder.indexOf(value);
                return index === 0 || expectedIndex >= expectedHonorOrder.indexOf(honorTiles[index-1]);
            });
            
            isCorrect = isCorrect && honorOrderCorrect;
            
            showResult('result-2', isCorrect, 
                isCorrect ? '✓ 複雑ケーステスト成功' : 
                `✗ 複雑ケーステスト失敗 - 実際値: ${actualOrder.join(' ')}`
            );
        }

        // ランダム手牌生成
        let randomTiles = [];
        function generateRandomHand() {
            const bambooValues = [1, 2, 3, 4, 5, 6, 7, 8, 9];
            const honorValues = ['white', 'green', 'red'];
            
            randomTiles = [];
            
            // ランダムに5-7枚の牌を生成
            const tileCount = Math.floor(Math.random() * 3) + 5;
            
            for (let i = 0; i < tileCount; i++) {
                const isHonor = Math.random() < 0.3; // 30%の確率で字牌
                
                if (isHonor) {
                    const value = honorValues[Math.floor(Math.random() * honorValues.length)];
                    randomTiles.push({
                        id: `random-${i}`,
                        suit: 'honor',
                        value: value
                    });
                } else {
                    const value = bambooValues[Math.floor(Math.random() * bambooValues.length)];
                    randomTiles.push({
                        id: `random-${i}`,
                        suit: 'bamboo',
                        value: value
                    });
                }
            }
            
            displayTiles(randomTiles, 'before-hand-3');
            document.getElementById('after-hand-3').innerHTML = '';
            document.getElementById('result-3').style.display = 'none';
        }

        // テスト3: ランダムソート
        function runRandomSortTest() {
            if (randomTiles.length === 0) {
                showResult('result-3', false, '先にランダム手牌を生成してください');
                return;
            }
            
            const sortedTiles = sortTilesForDisplay(randomTiles);
            displayTiles(sortedTiles, 'after-hand-3');
            
            // ソート結果の妥当性をチェック
            let isValid = true;
            let lastBambooValue = 0;
            let lastHonorPriority = 0;
            let inHonorSection = false;
            
            const getHonorPriority = (value) => {
                switch (value) {
                    case 'white': return 1;
                    case 'green': return 2;
                    case 'red': return 3;
                    default: return 4;
                }
            };
            
            for (let tile of sortedTiles) {
                if (tile.suit === 'bamboo') {
                    if (inHonorSection) {
                        isValid = false; // 字牌の後に索子が来てはいけない
                        break;
                    }
                    const value = parseInt(tile.value);
                    if (value < lastBambooValue) {
                        isValid = false; // 索子が昇順でない
                        break;
                    }
                    lastBambooValue = value;
                } else if (tile.suit === 'honor') {
                    inHonorSection = true;
                    const priority = getHonorPriority(tile.value);
                    if (priority < lastHonorPriority) {
                        isValid = false; // 字牌が正しい順序でない
                        break;
                    }
                    lastHonorPriority = priority;
                }
            }
            
            showResult('result-3', isValid, 
                isValid ? '✓ ランダムソートテスト成功' : '✗ ランダムソートテスト失敗'
            );
        }

        // 全テスト実行
        function runAllTests() {
            const resultsContainer = document.getElementById('all-results');
            resultsContainer.innerHTML = '<h4>全テスト実行中...</h4>';
            
            setTimeout(() => {
                runBasicSortTest();
                runComplexSortTest();
                generateRandomHand();
                setTimeout(() => {
                    runRandomSortTest();
                    
                    // 結果をまとめて表示
                    const result1 = document.getElementById('result-1').textContent.includes('✓');
                    const result2 = document.getElementById('result-2').textContent.includes('✓');
                    const result3 = document.getElementById('result-3').textContent.includes('✓');
                    
                    const allPassed = result1 && result2 && result3;
                    
                    resultsContainer.innerHTML = `
                        <h4>全テスト結果:</h4>
                        <div class="test-result ${allPassed ? 'success' : 'error'}">
                            ${allPassed ? '✓ 全テスト成功！手牌ソート機能は正常に動作しています。' : 
                              '✗ 一部テストが失敗しました。詳細は各テストセクションを確認してください。'}
                        </div>
                        <ul>
                            <li>基本ソートテスト: ${result1 ? '✓ 成功' : '✗ 失敗'}</li>
                            <li>複雑ケーステスト: ${result2 ? '✓ 成功' : '✗ 失敗'}</li>
                            <li>ランダムソートテスト: ${result3 ? '✓ 成功' : '✗ 失敗'}</li>
                        </ul>
                    `;
                }, 100);
            }, 100);
        }

        // 初期化
        window.onload = function() {
            generateRandomHand();
        };
    </script>
</body>
</html>